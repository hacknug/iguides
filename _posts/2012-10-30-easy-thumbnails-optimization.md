---
layout: index
title: Оптимизация изображений, сгенерированных easy-thumbnails (PIL)
categories: [django, оптимизация, fasttip]
---

Я пользуюсь `easy-thumbnails` в django-проектах для генерации превьюшек.
Предпочтение ему перед `sorl.thumbnail` отдано по большей части из-за того, что
его юзает замечательный `django-filer`. И вот однажды, натравив на очередной
сайт Google PageSpeed Insights получил от него рапорт, что вот-де, изображения
жутко неоптимизированы, можно ужать больше чем в половину.

Как оказалось, виновной оказалась PIL (да, "она", это же библиотека :D) - ведь
изображение генерируется ей. Недолгий поиск привел меня к issue на github с
просьбой добавить сигнал сохранения сгенерированного превью. Осталось лишь
навесить подобающий обработчик, что я и сделал.

Смотрим код:

{% gist 3978536 %}

На deb-based требуются установленные пакеты `jpegoptim, optipng, pngcrush,
advancecomp`.  Обработчики навешаны на два сигнала: при создании превью и при
сохранении изображения - например, через django-filer.  Есть нюансы:

- при использовании filer при сохранении нового изображения оптимизация
  происходит после вызова `save`, и в результате записанный в модель hash
  отличается от фактического. Если ваш код зависит от этого поля - нужно учесть.
  Сам же filer, если не ошибаюсь, это поле нигде не использует, так что я по
  этому поводу не парился

- если на странице имеется куча превьюшек, процесс их создания/оптимизации
  (особенно для PNG!) может затянуться. Потом кешируются, впрочем, так что
  ничего страшного

Определение типа изображения и, соответственно, какие тулзы к нему применять,
основывается на дедовском способе - по расширению. В данный момент
поддерживаются JPEG и PNG, их мне вполне хватает. Код функции оптимизации подло
выдран из [trimage][].



[trimage]: http://trimage.org/
